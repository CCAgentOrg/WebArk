name: CI/CD

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  # Unit Tests
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run unit tests
        run: npm test
        env:
          CI: true

  # Lint
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check JS syntax
        run: |
          # Check all JS files for syntax errors
          npx acorn --module public/js/translations.js --silent && echo "translations.js: OK"
          npx acorn --module public/js/providers.js --silent && echo "providers.js: OK"
          npx acorn --module public/index.html --silent || node -e "require('fs').readFileSync('public/index.html','utf8').match(/<script>[\s\S]*?<\/script>/g).forEach((s,i)=>{try{new Function(s.replace(/<\/?script>/g,''))}catch(e){console.error('Script '+i+': '+e.message);process.exit(1)}})"
      
      - name: HTML validation
        run: |
          # Basic HTML checks
          grep -q '<!DOCTYPE html>' public/index.html && echo "DOCTYPE: OK"
          grep -q '<html' public/index.html && echo "html tag: OK"
          grep -q '</html>' public/index.html && echo "closing html: OK"
          grep -q '<head>' public/index.html && echo "head: OK"
          grep -q '</head>' public/index.html && echo "closing head: OK"
          grep -q '<body>' public/index.html && echo "body: OK"
          grep -q '</body>' public/index.html && echo "closing body: OK"

  # Browser Automation Tests
  browser-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Install Playwright
        run: npx playwright install --with-deps chromium
      
      - name: Start local server
        run: |
          npx serve public -l 3456 &
          sleep 3
      
      - name: Run browser automation tests
        run: |
          node --experimental-vm-modules node_modules/playwright/index.mjs tests/browser.mjs
        env:
          BASE_URL: http://localhost:3456

  # Build verification
  build:
    runs-on: ubuntu-latest
    needs: [unit-tests, lint, browser-tests]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify files exist
        run: |
          test -f public/index.html && echo "index.html: OK"
          test -f public/manifest.json && echo "manifest.json: OK"
          test -f public/sw.js && echo "sw.js: OK"
          test -f public/js/translations.js && echo "translations.js: OK"
          test -f public/js/providers.js && echo "providers.js: OK"
      
      - name: Check file sizes
        MAX_HTML=100000
        MAX_JS=100000
        HTML_SIZE=$(wc -c < public/index.html)
        JS_SIZE=$(wc -c < public/js/translations.js)
        echo "index.html size: $HTML_SIZE bytes"
        echo "translations.js size: $JS_SIZE bytes"
        test $HTML_SIZE -lt $MAX_HTML || (echo "index.html too large" && exit 1)
        test $JS_SIZE -lt $MAX_JS || (echo "translations.js too large" && exit 1)

  # Build extension
  build-extension:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build extension
        run: |
          mkdir -p dist
          zip -r dist/webark-extension.zip extension/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: webark-extension
          path: dist/webark-extension.zip
